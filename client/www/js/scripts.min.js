
(function() {
  'use strict'

  var dependencies = [
    'ui.router',
    'googlechart',
    'ngAnimate',
    'ngMessages',
    'angularMoment',
    'duScroll'
  ]

  angular.module('panic', dependencies)
  .constant({'API_URL': resolveApiUrl() + '/api/v1'})
  .run(routeEvent)

  resolveApiUrl.$inject = ['$http']

  function resolveApiUrl($http){
    if(window.location.origin === "http://localhost:5000") return 'http://localhost:3000';
    return 'https://grasp-app.herokuapp.com'
  }

  routeEvent.$inject = ['$rootScope', '$state', '$window', 'authService'];

  function routeEvent($rootScope, $state, $window, authService){
    $rootScope.$on('$stateChangeStart', function(event, toState, toParams, fromState, fromParams){
      if(!$window.localStorage.getItem('token') && toState.loggedInOnly){
        event.preventDefault();
        $state.go('landing');
      }
      if($window.localStorage.getItem('token') && toState.loggedOutOnly){
        event.preventDefault();
        $state.go('attending');
      }
      //TODO: create a http call to check if the person going to this page is the instructor
      // if($window.localStorage.getItem('token') && toState.instructorOnly){
        // authService.verifyInstructor($window.localStorage.getItem('email'), $window.localStorage.getItem('token')).then(function(result){
        //   if (result === true) {
        //     $state.go('teaching');
        //   } else {
        //     event.preventDefault();
        //     $state.go('dashboard');
        //   }
        // })
        //  console.log('interceptor- instructorOnly///////////////');
        // event.preventDefault();
      //   $state.go('dashboard');
      // }
      // if(!$window.localStorage.getItem('token') && toState.instructorOnly){
      //   event.preventDefault();
      //   $state.go('landing');
      // }
    })
  }
})();

(function() {
  'use strict';

  angular.module('panic')
  .factory('authService', authFactory);

 authFactory.$inject = [
    '$log',
     '$http',
     '$state',
     '$window',
     'API_URL'
  ];

  function authFactory ($log, $http, $state, $window, API_URL) {
    var AUTH_ENDPOINTS = $http.get(API_URL).then(function (res){
      return $http.get(res.data.auth)
    })

    var authFactory = {
      session: {currentUser: null},
      login: login,
      signup: signup,
      me: me
    }

    return authFactory

    function login (user) {
      return AUTH_ENDPOINTS.then(function(AUTH_ENDPOINTS){
        AUTH_ENDPOINTS = AUTH_ENDPOINTS.data;
        return $http.post(AUTH_ENDPOINTS.login, user).then(function (res){
          $window.localStorage.setItem('token', res.data.token)
          return res.data
        })
      })
    }

    function signup (user) {
      return AUTH_ENDPOINTS.then(function(AUTH_ENDPOINTS){
        AUTH_ENDPOINTS = AUTH_ENDPOINTS.data;
        return $http.post(AUTH_ENDPOINTS.signup, user).then(function (res){
          $window.localStorage.setItem('token', res.data.token)
          return res.data
        })
      })
    }

    function me(){
      return AUTH_ENDPOINTS.then(function(AUTH_ENDPOINTS){
        AUTH_ENDPOINTS = AUTH_ENDPOINTS.data;
        return $http.get(AUTH_ENDPOINTS.me).then(function(res){
          authFactory.session.currentUser = Object.keys(res.data).length > 0 ? res.data : null;
          return Promise.resolve(authFactory.session);
        }).catch(function (err){
          return Promise.reject(err);
        });
      });
    }
  }
}());

(function() {
  'use strict';

  angular.module('panic')
  .factory('dashboardService', dashboardFactory);

 dashboardFactory.$inject = [
    '$log',
     '$http',
     '$state',
     '$window',
     'API_URL'
  ];

  function dashboardFactory ($log, $http, $state, $window, API_URL) {
    var getParticipants = function () {
      return $http.get(API_URL).then(function (res){
        return $http.get(res.data.participations)
      })
    }

    var POST_CLASSES_ENDPOINTS = $http.get(API_URL).then(function (res){
      return res.data.classes.post
    })

    var _classes = {};
    _classes._teaching = [];
    _classes._attending = [];

    var _previousPage;

    var dashboardFactory = {
      getClasses: getClasses,
      getLectures: getLectures,
      addClass: addClass,
      addLecture: addLecture,
      setPreviousPage: setPreviousPage,
      getPreviousPage: getPreviousPage,
      startLecture: startLecture,
      endLecture: endLecture,
      currentLecture: currentLecture,
      addParticipant: addParticipant,
      deleteParticipant: deleteParticipant
    }

    return dashboardFactory

    function getClasses(){
      return getParticipants().then(function(res){
        _classes._teaching = [];
        _classes._attending = [];
        for (var i = 0; i < res.data.length; i++) {
          if(res.data[i].attributes.instructor){
            _classes._teaching.push(res.data[i]);
          } else {
            _classes._attending.push(res.data[i]);
          }
        }
        return _classes;
        }).catch(function (err){
          return err;
        })
    }

    function getLectures (classId, url) {
      return $http.get(url).then(function (res) {
        for (var i = 0; i < _classes._teaching.length; i++) {
          if (_classes._teaching[i].attributes.id == classId) {
          _classes._teaching[i].attributes.lectures = res.data;
          return   _classes._teaching[i]
          }
        }
        for (var i = 0; i < _classes._attending.length; i++) {
          if (_classes._attending[i].attributes.id == classId){
            _classes._attending[i].attributes.lectures = res.data;
            return _classes._attending[i]
          }
        }
      })
    }

    function addClass(newClass) {
      return POST_CLASSES_ENDPOINTS.then(function (res){
        return $http.post(res, newClass)
        .then(function(res){
          _classes._teaching.push(res.data)
          return _classes
        })
      })
    }

    function addLecture (newLecture, url) {
      return $http.post(url, newLecture)
      .then(function (res) {
        return res.data;
      })
    }

    function setPreviousPage (classId) {
      _previousPage = classId;
      return
    }

    function getPreviousPage () {
      return _previousPage
    }

    function startLecture (url) {
      return $http.post(url).then(function (res) {
        return res
      })
    }

    function endLecture (url) {
      var newUrl = API_URL + '/lectures/'+ url +'/stop'
      return $http.post(newUrl).then(function (res){
        return res
      })
    }

    function currentLecture(lectureId){
      var newUrl = API_URL + '/lectures/'+ lectureId
      return $http.get(newUrl).then(function (res){
        return res.data;
      })
    }

    function addParticipant(url, newParticipant){
      return $http.post(url, newParticipant).then(function(res){
        return res
      })
    }

    function deleteParticipant (url){
      return $http.delete(url).then(function(res){
        return res
      })
    }

  }
}());

(function() {
  'use strict'

  angular.module('panic')
  .config(setupRoutes)

  setupRoutes.$inject = [
    '$stateProvider',
    '$urlRouterProvider',
    '$locationProvider',
    '$httpProvider',
  ];

  function setupRoutes($stateProvider, $urlRouterProvider, $locationProvider, $httpProvider) {
    $httpProvider.interceptors.push("AuthInterceptorService");
    $locationProvider.html5Mode(true);
    $urlRouterProvider.otherwise("/");

    $stateProvider
      .state('landing', {
        url: '/',
        template: "<landing-directive></landing-directive>",
        loggedOutOnly: true
      })
      .state('student', {
        url: '/lectures/:lectureId/student',
        template: "<lecture-student></lecture-student>",
        resolve: {
          user: getMe
        }
      })
      .state('teacher', {
        url: '/lectures/:lectureId/instructor',
        template: "<lecture-teacher></lecture-teacher>",
        loggedInOnly: true,
      })
      .state('app', {
        abstract: true,
        template: "<dashboard></dashboard>"
      })
      // .state('dashboard', {
      //   url: '/dashboard',
      //   parent: 'app',
      //   templateUrl: "partials/dashboard.main.html",
      //   loggedInOnly: true,
      //   resolve: {
      //     user: getMe
      //   }
      // })
      .state('teaching', {
        url: '/dashboard/teaching',
        templateUrl: "partials/dashboard.teaching.html",
        loggedInOnly: true,
        parent: 'app',
        resolve: {
          user: getMe
        }
      })
      .state('attending', {
        url: '/dashboard/attending',
        templateUrl: "partials/dashboard.attending.html",
        loggedInOnly: true,
        parent: 'app',
        resolve: {
          user: getMe
        }
      })
      .state('teachingLectures', {
        url: '/:classId',
        templateUrl: "partials/dashboard.teaching.info.html",
        loggedInOnly: true,
        parent: 'teaching',
        resolve: {
          user: getMe
        }
      })
      .state('attendingLectures', {
        url: '/:classId',
        templateUrl: "partials/dashboard.attending.info.html",
        loggedInOnly: true,
        parent: 'attending',
        resolve: {
          user: getMe
        }
      })
  }

  getMe.$inject = ['authService'];
  function getMe(authService) {
    return authService.me();
  }

})();

(function() {
  'use strict';

    angular.module('panic')
      .directive('landingDirective', landingDirective);

      function landingDirective (){
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/landing.html",
          controller: landingController,
          controllerAs: "vm"
        }
      }

      landingController.$inject = [
        '$scope',
        '$log',
        '$state',
        'authService',
        '$document'
      ];


      function landingController($scope, $log, $state, authService, $document) {
        var vm = this;
        vm.classCodeSubmit = classCodeSubmit;
        vm.loginSubmit = loginSubmit;
        vm.signupSubmit = signupSubmit;
        vm.scrollDown = scrollDown;

        //Actually scrolls DOWN - renaming to scrollDown() breaks the animation.
        function scrollDown() {
          $document.scrollTopAnimated(730, 1500);
        }

        function classCodeSubmit () {
            vm.frm = {}
          $state.go('student');
        }

        function loginSubmit () {
          var user = angular.copy(vm.login)
          authService.login(user).then(function (res){
            $state.go('attending');
          })
        }

        function signupSubmit (){
          var user = angular.copy(vm.signup);
          authService.signup(user).then(function (res){
            $state.go('attending');
          })
        }

      }

}());

(function() {
  'use strict';

    angular.module('panic')
      .directive('dashboard', dashboardDirective);

      function dashboardDirective (){
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/dashboard.html",
          controller: dashboardController,
          controllerAs: "vm"
        }
      }

      dashboardController.$inject = [
        '$log',
        '$state',
        'dashboardService',
        'authService',
        '$window',
        '$location'
      ];

      function dashboardController($log, $state, dashboardService, authService, $window, $location) {
        var vm = this;
        vm.info = {};
        vm.session = authService.session;
        vm.getLectures = getLectures;
        vm.addClass = addClass;
        vm.formClose = formClose;
        vm.addLecture = addLecture;
        vm.currentClass;
        vm.logout = logout;
        vm.setPreviousPage = setPreviousPage;
        vm.startLecture = startLecture;
        vm.addParticipant = addParticipant;
        vm.deleteParticipant = deleteParticipant;

        dashboardService.getClasses()
        .then(function (res){
          vm.teaching = res._teaching;
          vm.attending = res._attending;
          if(res._teaching.length > 0){
            for (var i = 0; i < res._teaching.length; i++) {
              if(+res._teaching[i].attributes.id === +$state.params.classId) {
                vm.currentClass = res._teaching[i];
                return getLectures(res._teaching[i]);
              }
            }
          }
          if(res._teaching.length > 0){
            for (var i = 0; i < res._attending.length; i++) {
              if(+res._attending[i].attributes.id === +$state.params.classId) {
                vm.currentClass = res._attending[i];
                return getLectures(res._attending[i]);
              }
            }
          }
        })

        function getLectures (currentClass){
          vm.currentClass = currentClass;
          return dashboardService.getLectures(currentClass.attributes.id, currentClass.links.summary)
          .then(function(currentClass) {
            vm.currentClass = currentClass
            vm.links = currentClass.attributes.lectures.links;
            vm.info = currentClass.attributes.lectures.attributes;
            return
          })
        }

        function addClass (myForm){
          var newClass = angular.copy(vm.class)
          myForm.$setPristine();
          myForm.$setUntouched();
          vm.class = {};
          return dashboardService.addClass(newClass)
          .then(function(res){
            return res
          });
        }

        function setPreviousPage(classId){
          dashboardService.setPreviousPage(classId);
          return
        }

        function addLecture (form) {
          var newLecture = angular.copy(vm.lecture);
          form.$setPristine();
          form.$setUntouched();
          vm.lecture = {};
          return dashboardService.addLecture(newLecture, vm.links.lectures.post)
          .then(function(res){
            vm.info.lectures.push(res);
            return
          });
        }

        function formClose (form) {
          form.$setPristine();
          form.$setUntouched();
          vm.class = {};
          vm.lecture = {};
          vm.student = {};
          return
        }

        function logout () {
          $window.localStorage.clear();
          $state.go('landing');
          return
        }

        function startLecture(lecture, lectureId){
          setPreviousPage(lectureId)
          dashboardService.startLecture(lecture.links.start)
          .then(function (res){
            if(res.status === 200){
              $state.go('teacher', {lectureId: lecture.attributes.lecture_id});
            }
          })
        }

        function addParticipant(form){
          var newParticipant = angular.copy(vm.student);
          dashboardService.addParticipant(vm.links.participants.post, newParticipant).then(function(res){
            vm.info.participants.push(res.data);
            vm.student = {};
            form.$setPristine();
            form.$setUntouched();
          });
        }

        function deleteParticipant (participant){
            dashboardService.deleteParticipant(participant.links.delete)
            .then(function (res){
              for (var i = 0; i < vm.info.participants.length; i++) {
                if(vm.info.participants[i].attributes.user_id == res.data[0].user_id){
                   vm.info.participants.splice(i, 1);
                }
              }
              return vm.info
            })

        }

      }
}());

(function() {
  'use strict';
    angular.module('panic')
      .directive('lectureStudent', lectureDirective);

      function lectureDirective (){
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/lecture.student.html",
          controller: lectureController,
          controllerAs: "vm"
        }
      }

      lectureController.$inject = [
        '$log',
        '$state',
        'authService',
        'dashboardService',
        '$interval',
        'lectureStudentService'
      ];

      function lectureController($log, $state, authService, dashboardService, $interval, lectureStudentService) {
        var url = (window.location.origin === "http://localhost:5000") ? 'http://localhost:3000' : 'https://panic-button-g20.herokuapp.com'
        var socket = io.connect(url);
        var vm = this;
        var lecture_id = $state.params.lectureId;
        var interval = null;
        vm.session = authService.session;
        vm.canClick = lectureStudentService.canVote();
        vm.currentUnderstanding = lectureStudentService.getCurrentUnderstanding();
        vm.vote = vote;

        vm.previousPage = dashboardService.getPreviousPage();

        if(vm.canClick === false && lectureStudentService.getTimer() > 0){
          startTimer();
        }else{
          vm.canClick = true;
        }

        function vote (status_id) {
          if(!interval){
            switch (status_id) {
              case 1:
                vm.currentUnderstanding = lectureStudentService.setCurrentUnderstanding("don't understand :-(");
                break;
              case 3:
                vm.currentUnderstanding = lectureStudentService.setCurrentUnderstanding(" get it! :-)");
                break;
              default:
            }
            vm.canClick = lectureStudentService.voted();
            socket.emit('chart', {lecture_id: +lecture_id, user_id: authService.session.currentUser.id, status_id: status_id} );

            startTimer();
          }
        }

        function startTimer(){
          vm.timer = lectureStudentService.getTimer();
          interval = $interval(function(){
            vm.timer = lectureStudentService.getTimer();
            if(lectureStudentService.getTimer() <= 0){
              $interval.cancel(interval);
              interval = null;
              vm.timer = lectureStudentService.resetTimer();
              vm.canClick = lectureStudentService.canVote();
            }
          }, 1000)
        }

      }

}());

(function() {
  'use strict';

    angular.module('panic')
      .directive('lectureTeacher', lectureTeacherDirective);

      function lectureTeacherDirective () {
        return {
          restrict: "E",
          scope: {},
          templateUrl: "partials/lecture.teacher.html",
          controller: lectureTeacherController,
          controllerAs: "vm"
        }
      }

      lectureTeacherController.$inject = [
        '$log',
        '$state',
        'dashboardService'
      ];

      function lectureTeacherController($log, $state, dashboardService) {
        var vm = this;
        vm.endLecture = endLecture;
        vm.previousPage = dashboardService.getPreviousPage();

        dashboardService.currentLecture($state.params.lectureId).then(function(res){
          vm.currentLecture = res;
          return
        });

        function endLecture () {
          dashboardService.endLecture($state.params.lectureId);
          $state.go('teaching');
        }

      }

}());

(function() {
  'use strict';

  angular.module('panic')
  .factory('AuthInterceptorService', factory)

    factory.$inject = ['$window', '$injector'];

    function factory($window, $injector) {
    return {
     'request': function(req) {
        var token = localStorage.getItem('token');
        if (token) req.headers.authentication = token;
        return req;
      },

      'responseError': function(response) {
        if(response.status === 401) {
          $window.localStorage.clear();
          $injector.get('$state').go('landing');
        }
        return response;
        }
      };
    }

}());

(function() {
  'use strict';

  angular.module('panic')
  .directive('areaChart', directive)

  function directive () {
    return {
      scope: {},
      template: '<div google-chart chart="areaChart"></div>',
      controller: controller,
    }

    function controller ($scope, $rootScope, ChartFactory) {

      $scope.$watch(function(){
        return ChartFactory.graphData;
      },
      function (newValue) {
        graph(newValue);
      }, true);

      function graph (tally) {
        if(!tally) return;
        var units = tally.units;
        var tally = tally.data;
        areaChart.data.rows = []
        areaChart.data.rows.push({c: [{v: 0},{v: 0},{v: 100},{v: 0} ] })
        for (var time in tally) {
          var total = tally[time]['1'] + tally[time]['2'] + tally[time]['3']
          var d = tally[time][1]/total * 100
          var u = tally[time][2]/total * 100
          var g = tally[time][3]/total * 100
          areaChart.data.rows.push({c: [{v: time }, {v: d}, {v: u}, {v: g}] })
          areaChart.options.hAxis.title = "Time (" + units + ")";
        }
      }

      var areaChart = {};
      areaChart.type = "AreaChart";
      areaChart.displayed = false;
      areaChart.data = {};
      areaChart.data.rows = []


      areaChart.data.cols = [
          {id: "month",label: "Month",type: "string"},
          {id: "DaFuq",label: "I don't get it",type: "number"},
          {id: "NoVote",label: "Undecided",type: "number"},
          {id: "GotIt",label: "I got it",type: "number"},
        ];
      areaChart.options = {
        "title": $scope.className,
        "isStacked": "true",
        "fill": 20,
        "displayExactValues": true,
        "vAxis": {
          "title": "Percent class",
          "gridlines": {
            "count": 5
          }
        },
        "hAxis": {
          "title": "Time",
          "scaleType": 'log'

        }
      };
      $scope.areaChart = areaChart;
    }
  }




}());

(function() {
  'use strict';


  angular.module('panic')
  .factory('ChartFactory', factory)

  // factory.$inject = [ '$rootScope', '$location']

  function factory ($rootScope, $location, $state, $http, $interval, API_URL) {
    $rootScope.$on( "$stateChangeSuccess", function(event, next, current) {
    })


    // Update graph data every minute if nobody has clicked.
    var updateInterval = null;
    var url = (window.location.origin === "http://localhost:5000") ? 'http://localhost:3000' : 'https://grasp-app.herokuapp.com'
    var socket = io.connect(url);

    socket.on($state.params.lectureId, function (data) {
      if (!service.dataCache.students[data.user_id]) service.dataCache.students[data.user_id] = []
        service.dataCache.students[data.user_id].push(data)
        service.graphData = createTally(service.dataCache);
        $rootScope.$apply()
    })

    var service = {
      lecture_start: null,
      lecture_id: $state.params.lectureId,
      dataCache: null,
      graphData: null,
      getGraphData: getGraphData,
    }


    return service

    function getGraphData () {

      if(service.graphData) return service.graphData;

      return $http.get(API_URL + '/lectures/'+service.lecture_id+'/understandings')
      .then( function (res) {
        service.lecture_start = res.data.lecture_start;
        service.dataCache = res.data
        service.graphData = createTally(res.data)
        return service.graphData
      })
    }

    $scope.$on('$destroy', function (event) {
      socket.removeAllListeners();
    });

    function createTally(data) {
      if(Object.keys(data.students).length === 0) return {1:{1:0, 2:0, 3:0}}

      var functionStart = Date.now();
      console.log(data);
      var students = data.students
      var timeStart = new Date(data.lecture_start);
      var timeEnd = data.lecture_end ? new Date(data.lecture_end) : new Date(Date.now());
      var timeChangeInMilliseconds = (timeEnd.getTime() - timeStart.getTime());


      // Determine graph interval
      var graphInterval = determineGraphInterval(timeChangeInMilliseconds);
      var interval = graphInterval.milliseconds;
      var units = graphInterval.units;
      setUpdateInterval(interval);

      var POINTS_ON_GRAPH = Math.ceil(timeChangeInMilliseconds / interval);
      var tally = {}


      // Build tally buckets
      for (var i = 1; i <= POINTS_ON_GRAPH; i++) {
        tally[i] = {1:0, 2:0, 3:0};
      }

      for (var studentId in students) {
        var student = students[studentId];
        for (var bucketId in tally) {
          var bucket = tally[bucketId];
          var bucketTime = new Date(timeStart.getTime() + (+bucketId * interval));
          var currentStatusIndex = 0;
          var previousStatus = student[currentStatusIndex] || {status_id: 2};

          for(var i = currentStatusIndex; i < student.length; i++){
            var status = student[i];

            var created_at = new Date(status.created_at);

            if (created_at.getTime() < bucketTime.getTime()){
              previousStatus = status;
              currentStatusIndex = i;
              continue;
            }else{
              bucket[previousStatus.status_id]++;
              previousStatus = null;
              break;
            }
          }

          if (previousStatus) {
            bucket[previousStatus.status_id]++;
          }
        }
      }

      console.log("***** Final Tally ", tally);
      console.log( "Graphing took: ", Date.now() - functionStart, " milliseconds.");
      console.log( POINTS_ON_GRAPH, " points graphed.");
      console.log("Returning: ", {tally: tally, units: units});
      return { data: tally, units: units };
    }

    function setUpdateInterval(interval){
      if(updateInterval) $interval.cancel(updateInterval);

      updateInterval = $interval(function(){
        service.graphData = createTally(service.dataCache);
      }, interval);
    }
  }


  // function createTally (data) {
  //   var functionStart = Date.now();
  //   console.log(data);
  //   var students = Object.keys(data).length
  //   var students = data.students
  //   var timeStart = new Date(data.lecture_start);
  //   var timeEnd = data.lecture_end
  //   var lastDif = timeEnd === null ? new Date(Date.now()) : '...';
  //   var timeArray =[]
  //   var timeData = {};
  //   var tally = {};
  //   var highestDif = 0;
  //   for (var user in students ) {
  //     for (var i = 0; i < students[user].length; i++) {
  //       var dif = (Math.floor((new Date(students[user][i].created_at) - timeStart)/5)) +1
  //       highestDif = highestDif < dif ? dif : highestDif;
  //     }
  //   }
  //
  //
  //   for (var user in students ) {
  //     var oldDif = 1;
  //     for (var i = 0; i < students[user].length; i++) {
  //       var dif = (Math.floor((new Date(students[user][i].created_at) - timeStart)/5)) +1
  //       timeData[dif] = students[user][i].status_id
  //       if(dif - oldDif > 0){
  //         for(var j = oldDif; j < dif; j++){
  //           if(tally[j]){
  //             tally[j][timeData[oldDif]]++;
  //           }else{
  //             tally[j] = {1:0, 2:0, 3:0}
  //             tally[j][timeData[oldDif]]++;
  //           }
  //         }
  //         oldDif = dif;
  //       }
  //     }
  //
  //     // if(tally[dif]){
  //     //   tally[dif][timeData[dif]]++;
  //     // }else{
  //     //   tally[dif] = {1:0, 2:0, 3:0}
  //     //   tally[dif][timeData[dif]]++;
  //     // }
  //
  //
  //     for (var k = dif; k <= highestDif; k++) {
  //       if(tally[k]){
  //         tally[k][timeData[oldDif]]++;
  //       }else{
  //         tally[k] = {1:0, 2:0, 3:0}
  //         tally[k][timeData[oldDif]]++;
  //       }
  //     }
  //
  //   }
  //   // if (lastDif === '...') {
  //   //   tally["..."] = tally[Object.keys(tally).length];
  //   //    tally["end of lecture"] = tally["..."]
  //   // } else {
  //   //   tally['now'] = tally[Object.keys(tally).length]
  //   // }
  //   console.log('ta', tally);
  //   console.log( "Graphing took: ", Date.now() - functionStart, " milliseconds");
  //   return tally
  // }

  function determineGraphInterval(lengthOfLecture){
    var maxIntervals = 30;

    var thirtySeconds = 30000;
    var oneMinute = thirtySeconds * 2;
    var fiveMinutes = oneMinute * 5;
    var tenMinutes = oneMinute * 10;
    var fifteenMinutes = oneMinute * 15;
    var twentyMinutes = oneMinute * 20;
    var twentyFiveMinutes = oneMinute * 25;
    var thirtyMinutes = oneMinute * 30;
    var fourtyFiveMinutes = oneMinute * 45;
    var sixtyMinutes = oneMinute * 60;

    if(lengthOfLecture / thirtySeconds <= maxIntervals) return { milliseconds: thirtySeconds, units: "30 Seconds" };
    if(lengthOfLecture / oneMinute <= maxIntervals) return { milliseconds: oneMinute, units: "1 Minute" };
    if(lengthOfLecture / fiveMinutes <= maxIntervals) return { milliseconds: fiveMinutes, units: "5 Minutes" };
    if(lengthOfLecture / tenMinutes <= maxIntervals) return { milliseconds: tenMinutes, units: "10 Minutes" };
    if(lengthOfLecture / fifteenMinutes <= maxIntervals) return { milliseconds: fifteenMinutes, units: "15 Minutes" };
    if(lengthOfLecture / twentyMinutes <= maxIntervals) return { milliseconds: twentyMinutes, units: "20 Minutes" };
    if(lengthOfLecture / twentyFiveMinutes <= maxIntervals) return { milliseconds: twentyFiveMinutes, units: "25 Minutes" };
    if(lengthOfLecture / thirtyMinutes <= maxIntervals) return { milliseconds: thirtyMinutes, units: "30 Minutes" };
    if(lengthOfLecture / fourtyFiveMinutes <= maxIntervals) return { milliseconds: fourtyFiveMinutes, units: "45 Minutes" };
    return { milliseconds: sixtyMinutes, units: "60 Minutes" };
  }


  function convertToMinutes(milliseconds){
    return (((milliseconds) / 1000) / 60);
  }
}());

(function() {
  'use strict';

  angular.module('panic')
  .directive('pieChart', directive)

  function directive () {
    return {
      scope: {},
      template: '<div google-chart chart="pieChart" id="pieChart"></div>',
      controller: controller,
    }
    function controller ($scope, $rootScope, $state, ChartFactory) {

      var pieChart = {};
      var lecture_id = $state.params.id;
      var students = [];
      var g = 0;
      var d = 0;
      var u = 0;


      $scope.$watch(function(){
        return ChartFactory.graphData
      },
      function (newValue) {
        if (newValue) graph(newValue);
      }, true);

      function graph (tally) {
        var tally = tally.data;
        console.log('time****', tally);
        var time = Object.keys(tally).length
          var d = tally[time][1]
          var u = tally[time][2]
          var g = tally[time][3]
          $scope.vote[0]= { 'c': [ { 'v': 'I dont get it' }, {'v' : d} ] }
          $scope.vote[1] = { 'c': [ { 'v': 'undecided'}, {'v' : u} ] }
          $scope.vote[2] = { 'c': [ { 'v':  'I get it'}, {'v' : g } ] }
      }

      ChartFactory.getGraphData().then( function(data) { console.log('##########', data);})

      $scope.$on('$destroy', function (event) {
        socket.removeAllListeners();
      });

      pieChart.type = 'PieChart';
      pieChart.displayed = false;
      pieChart.data = {}
      $scope.vote = [];
      $scope.vote[0]= { 'c': [ { 'v': 'dafuq' }, {'v' : 0} ] }
      $scope.vote[1] = { 'c': [ { 'v': 'novote'}, {'v' : 100} ] }
      $scope.vote[2] = { 'c': [ { 'v':  'gotit'}, {'v' : 0 } ] }
      pieChart.data.rows = $scope.vote

      pieChart.data.cols = [
        { "id": "month", "label": "Month", "type": "string" },
        { "id": "laptop-id", "label": "Laptop", "type": "number" },
        { "id": "desktop-id", "label": "Desktop", "type": "number" },
        { "id": "server-id", "label": "Server", "type": "number" },
        { "id": "cost-id", "label": "Shipping", "type": "number" }
      ];

        pieChart.formatters = {}
        pieChart.options = {
          "isStacked": "true",
          "fill": 20,
          "displayExactValues": true,
          },



        $scope.pieChart = pieChart;
    }
  }


}());

angular.module('panic')
  .factory('lectureStudentService', service);

service.$inject = ['$window', '$rootScope', '$stateParams'];

function service($window, $scope, $stateParams){
  var defaultTimerValue = 31000;
  var lectures = getLectures();
  var lecture = lectures[$stateParams.id] ||
                { userCanVote: true,
                  currentUnderstanding: "",
                  timer: Date.now()-defaultTimerValue };
  lectures[$stateParams.id] = lecture;
  lecture.timer = new Date(lecture.timer)

  $scope.$on("$stateChangeSuccess", function(event, toState, toParams, fromState, fromParams){
    lectures = getLectures();
    lecture = lectures[$stateParams.id] ||
              { userCanVote: true,
                currentUnderstanding: "",
                timer: Date.now()-defaultTimerValue };
    lectures[$stateParams.id] = lecture;
    lecture.timer = new Date(lecture.timer)
  })

  var lectureStudentService = {
    canVote: canVote,
    voted: voted,
    resetTimer: resetTimer,
    getTimer: getTimer,
    getCurrentUnderstanding: getCurrentUnderstanding,
    setCurrentUnderstanding: setCurrentUnderstanding
  }

  return lectureStudentService;


  function canVote() {
    return lecture.userCanVote;
  }

  function voted() {
    lecture.userCanVote = false;
    lecture.timer = new Date(Date.now() + defaultTimerValue);
    setLectures();
    return lecture.userCanVote;
  }

  function resetTimer() {
    lecture.timer = new Date(Date.now() - defaultTimerValue);
    lecture.userCanVote = true;
    setLectures();
    return lecture.timer;
  }

  function getTimer() {
    var timer = (lecture.timer.getTime() - Date.now())
    return Math.floor((lecture.timer.getTime() - Date.now()) / 1000);
  }

  function getCurrentUnderstanding() {
    return lecture.currentUnderstanding;
  }

  function setCurrentUnderstanding(understanding) {
    lecture.currentUnderstanding = understanding;
    setLectures();
    return lecture.currentUnderstanding;
  }

  function getLectures() {
    return JSON.parse($window.localStorage.getItem('lectures')) || {};
  }

  function setLectures() {
    return $window.localStorage.setItem('lectures', JSON.stringify(lectures));
  }
}
